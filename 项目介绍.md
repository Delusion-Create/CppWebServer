# C-WebServer

本项目实现了一个基于Reactor模型的高性能HTTP服务器,使用 边缘模式epoll + 非阻塞 IO + 线程池实现了高并发的HTTP服务器,使用红黑树+哈希表结构维护的定时器+可扩充协议类+
双缓冲技术维护的异步日志类，实现HTTP/1.1 请求处理、Keep-Alive 连接管理、定时器超时回收、高性能异步日志记录,能够高效处理多路IO事件、管理连接生命周期及数据缓冲区，为高并发网络通信提供坚实基础。


## 功能实现：
基于Reactor模型实现高并发HTTP服务器，支持多路IO事件管理与协议扩展：

- TCPServer模块：oneloop模型设计、Reactor并发模型、epoll边缘模式、非阻塞IO
- 协议模块：提供HTTP协议支持，支持请求解析、响应组装与资源处理、支持扩展其他协议
- 连接生命周期管理：通过定时器自动清理非活跃连接，提升系统稳定性
- 定时器: 红黑树维护有序性、哈希表提供快速访问、智能指针管理内存，并辅以线程安全和惰性清理策略

- 异步日志：单例模式确保全局唯一性、生产者-消费者模型实现异步化，并核心采用了双缓冲技术和批量写入来优化性能，用原子类+互斥锁+条件变量兼顾了线程安全与资源管理 

## 项目成果：

构建基于Reactor模型的C++高性能服务器，核心采用epoll事件驱动与线程池实现高并发，通过智能指针及定时器自动管
理连接，内置模块化HTTP协议支持，提供完整请求处理能力，可作为Web、RPC等网络应用的高效基础组件。

## 技术栈：

C++、linux、epoll、线程池、定时器、异步日志、智能指针、哈希表、红黑树、TCP/HTTP、Cmake、Reactor模型、单例设计模式

## 核心特性
- HTTP/1.1 请求解析与响应构造（支持 GET/POST 基础场景）
- epoll 边缘驱动的高并发事件循环（非阻塞套接字）
- 线程池分发请求处理任务，避免阻塞主事件循环
- 红黑树维护的定时器,高效、安全、可靠
- Keep-Alive 连接识别与 30 秒超时定时器管理
- 简易路由示例：/ 与 /about，未命中返回 404
- 异步日志记录:基于双缓冲技术
- 代码模块化，易于扩展与维护

## 目录结构（src）
- main.cpp：程序入口，初始化日志、忽略 SIGPIPE，启动 TcpServer
- TcpServer.h / TcpServer.cpp：TCP 服务端封装，监听、accept、epoll 事件分发、连接关闭与定时器管理
- HttpServer.h / HttpServer.cpp：单连接的 HTTP 处理逻辑（读取、解析、响应、Keep-Alive 决策）
- HttpRequest.h / HttpRequest.cpp：HTTP 请求解析（方法、路径、头、体）
- HttpResponse.h / HttpResponse.cpp：HTTP 响应构造（状态码、头、体，序列化成报文）
- ThreadPool.h / ThreadPool.cpp：任务线程池（并发处理）
- TcpTimer.h / TcpTimer.cpp：连接定时器管理器（超时回收）
- TimerNode.h / TimerNode.cpp：定时器节点
- epoll.h / epoll.cpp：epoll 相关封装
- Logger.h / Logger.cpp：异步日志系统（文件输出 server.log）
- Util.h / Util.cpp：工具函数（SIGPIPE 处理等）
- Makefile：构建脚本，目标二进制为 src/webserver
- webbench：压测工具相关文件（可用于简单压力测试）

## 架构与工作流程
1. 启动阶段
   - main.cpp 初始化异步日志系统（server.log），忽略 SIGPIPE
   - 创建并运行 TcpServer（默认 127.0.0.1:8848）
2. 事件循环
   - TcpServer 使用 epoll 监听套接字与客户端 fd
   - 新连接通过 accept() 接入，设置非阻塞，注册到 epoll
   - 可读事件触发后，将 fd 交由线程池任务处理
3. 请求处理（HttpServer::process）
   - 非阻塞读取接收缓冲，拼接成完整请求字符串
   - 解析失败：返回 400 Bad Request
   - 解析成功：根据方法与路径构造响应
     - GET /        -> 200 + 文本
     - GET /about   -> 200 + 文本
     - 其他路径     -> 404 Not Found
     - POST         -> 回显请求体
   - 根据 Connection 头判断 Keep-Alive：
     - keep-alive -> 在 TcpServer 中为该 fd 设置 30s 定时器（setupTimer）
     - close      -> 直接关闭连接（closeConnection）
4. 连接与定时器
   - TcpServer 维护 fd 的超时定时器，超时自动移除与关闭连接
   - 支持主动关闭连接（read=0 或错误）

## 构建与运行
项目使用 Makefile 管理构建，目标二进制输出在 src 目录。

- 构建
  ```bash
  bash build.sh
  ```

- 运行（默认地址）
  ```bash
  cd out
  ./webserver
  ```
  说明：未提供参数时，程序将提示用法，并以 127.0.0.1:8848 运行。

- 运行（带参数）
  ```bash
  ./webserver <ip> <port>
  ```
- 测试
  ```bash
   ./webbench -t 5 -c 1000 http://127.0.0.1:8848/
  ```

## 使用示例
- 访问首页
  ```bash
  curl -i http://127.0.0.1:8848/
  ```
- 访问关于页
  ```bash
  curl -i http://127.0.0.1:8848/about
  ```
- 发送 POST 请求
  ```bash
  curl -i -X POST http://127.0.0.1:8848/echo -d "hello"
  ```
  返回将包含 "Received POST data: hello" 文本。

- Keep-Alive 示例
  ```bash
  curl -i -H "Connection: keep-alive" http://127.0.0.1:8848/
  ```
  响应将包含 Keep-Alive 相关头，并在服务端为该连接设置 30 秒超时定时器。

## 日志
- 日志文件：server.log（与可执行程序同目录）
- 等级：INFO/ERROR/FATAL/DEBUG/WARNING
- 启停：程序启动时 init，退出前 stop

## 重要常量与参数
- 默认监听：127.0.0.1:8848（main.cpp）
- Keep-Alive 超时：30 秒（HttpServer -> TcpServer::setupTimer）
- MAXEPOLLEVENTS：524287（TcpServer.h）
- 编译选项：-Wall -Wextra -O2 -std=c++17（Makefile）

## 开发与扩展建议
- 路由扩展：在 HttpServer::handleHttpRequest 中增加路径分发或引入路由表
- 静态文件：增加文件读取与 Content-Type 识别，返回静态资源
- 错误处理：完善异常状态码与错误页面
- 配置化：增加配置文件或命令行解析库，消除硬编码 IP/端口
- 安全性：增加输入长度限制、头部大小约束、超长行处理，避免内存过度占用

